# ==========================================================
# üèóÔ∏è  Etapa 1: Construcci√≥n (Builder)
# ==========================================================
FROM eclipse-temurin:21-jdk AS build

# Carpeta de trabajo dentro del contenedor
WORKDIR /workspace

# ----------------------------------------------------------
# üì¶ Copiamos los archivos m√≠nimos para aprovechar la cach√©
# ----------------------------------------------------------
COPY gradlew ./
# Instalamos dos2unix para corregir el formato CRLF de Windows
# y aseguramos permisos de ejecuci√≥n
RUN apt-get update && apt-get install -y dos2unix && \
    dos2unix gradlew && chmod +x gradlew

# Copiamos el wrapper de Gradle y archivos de configuraci√≥n
COPY gradle ./gradle
COPY build.gradle settings.gradle gradle.properties ./
# Si usas versi√≥n catalog:
# COPY gradle/libs.versions.toml gradle/libs.versions.toml

# ----------------------------------------------------------
# üß∞ Descargamos dependencias sin compilar (usa cache)
# ----------------------------------------------------------
RUN ./gradlew --no-daemon dependencies || true

# ----------------------------------------------------------
# üìÅ Copiamos el c√≥digo fuente de la app
# ----------------------------------------------------------
COPY src ./src

# ----------------------------------------------------------
# üß± Compilamos el proyecto en modo fast-jar (m√°s liviano)
# ----------------------------------------------------------
RUN ./gradlew --no-daemon clean build -Dquarkus.package.type=fast-jar

# ==========================================================
# üöÄ Etapa 2: Ejecuci√≥n (Runner)
# ==========================================================
FROM eclipse-temurin:21-jre AS runner

# Carpeta de trabajo final
WORKDIR /app

# Copiamos el resultado de la compilaci√≥n
COPY --from=build /workspace/build/quarkus-app/ /app/

# Configuraci√≥n de red
ENV QUARKUS_HTTP_HOST=0.0.0.0
EXPOSE 8080

# Comando de inicio de la aplicaci√≥n
CMD ["java", "-jar", "/app/quarkus-run.jar"]
